<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="header.title">ISET Sfax AI Assistant</title>
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Noto+Sans+Arabic:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous">
    <style>
        :root {
            /* Refined color palette for professional look */
            --primary: #0A2463;
            --primary-dark: #081A4A;
            --primary-light: #1E40AF;
            --secondary: #F59E0B;
            --secondary-dark: #D97706;
            --secondary-light: #FBBF24;
            --accent: #E5E7EB;
            --text-dark: #1F2937;
            --text-light: #F9FAFB;
            --background-light: #F9FAFB;
            --background-dark: #111827;
            --success: #10B981;
            --info: #3B82F6;
            --warning: #F59E0B;
            --danger: #EF4444;
            --text-muted: #6B7280;
            --border-light: #D1D5DB;
            
            /* Spacing and sizing */
            --border-radius-sm: 8px;
            --border-radius: 12px;
            --border-radius-lg: 16px;
            --border-radius-xl: 24px;
            --box-shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.05);
            --box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
            --box-shadow-md: 0 12px 24px rgba(0, 0, 0, 0.12);
            --box-shadow-lg: 0 15px 30px rgba(0, 0, 0, 0.15);
            --transition-fast: all 0.2s ease;
            --transition: all 0.3s ease;
            --transition-slow: all 0.5s ease;
            --font-primary: 'Inter', 'Noto Sans Arabic', sans-serif;
            --header-height: 80px;
            --spacing-1: 4px;
            --spacing-2: 8px;
            --spacing-3: 12px;
            --spacing-4: 16px;
            --spacing-5: 20px;
            --spacing-6: 24px;
            --spacing-8: 32px;
        }
          .feedback-section {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-top: 20px;
        padding: 16px;
        border-radius: 8px;
        background-color: rgba(245, 247, 250, 0.7);
        border: 1px solid rgba(0, 0, 0, 0.05);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.02);
        transition: all 0.3s ease;
    }

    .dark .feedback-section {
        background-color: rgba(30, 41, 59, 0.7);
        border: 1px solid rgba(255, 255, 255, 0.05);
    }

    .feedback-section::before {
        content: "Was this response helpful?";
        font-size: 14px;
        font-weight: 500;
        color: var(--text-dark);
        margin-right: auto;
    }

    .dark .feedback-section::before {
        color: var(--text-light);
    }

    .btn-feedback {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        padding: 8px 16px;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.2s ease;
        border: 1px solid transparent;
        cursor: pointer;
        background: transparent;
        color: var(--text-dark);
        position: relative;
        overflow: hidden;
    }

    .dark .btn-feedback {
        color: var(--text-light);
    }

    .btn-feedback::after {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 0;
        height: 0;
        background-color: rgba(0, 0, 0, 0.05);
        border-radius: 50%;
        transform: translate(-50%, -50%);
        transition: width 0.4s, height 0.4s;
        z-index: -1;
    }

    .dark .btn-feedback::after {
        background-color: rgba(255, 255, 255, 0.05);
    }

    .btn-feedback:hover::after {
        width: 150px;
        height: 150px;
    }

    .btn-feedback[data-rating="positive"] {
        border-color: rgba(16, 185, 129, 0.3);
    }

    .btn-feedback[data-rating="negative"] {
        border-color: rgba(239, 68, 68, 0.3);
    }

    .btn-feedback[data-rating="positive"]:hover {
        background-color: rgba(16, 185, 129, 0.1);
        border-color: rgba(16, 185, 129, 0.5);
    }

    .btn-feedback[data-rating="negative"]:hover {
        background-color: rgba(239, 68, 68, 0.1);
        border-color: rgba(239, 68, 68, 0.5);
    }

    .btn-feedback[data-rating="positive"] i {
        color: var(--success);
    }

    .btn-feedback[data-rating="negative"] i {
        color: var(--danger);
    }

    .btn-feedback.rated,
    .btn-feedback:disabled {
        opacity: 0.6;
        cursor: default;
        pointer-events: none;
    }

    .btn-feedback[data-rating="positive"].rated {
        background-color: rgba(16, 185, 129, 0.1);
        border-color: rgba(16, 185, 129, 0.5);
    }

    .btn-feedback[data-rating="negative"].rated {
        background-color: rgba(239, 68, 68, 0.1);
        border-color: rgba(239, 68, 68, 0.5);
    }

    /* Animation for feedback buttons */
    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.05); }
        100% { transform: scale(1); }
    }

    .btn-feedback:active {
        transform: scale(0.95);
    }

    .feedback-message {
        font-size: 14px;
        padding: 8px 12px;
        border-radius: 6px;
        margin-top: 12px;
        background-color: rgba(16, 185, 129, 0.1);
        color: var(--success);
        text-align: center;
        animation: fadeIn 0.3s ease-in-out;
        border: 1px solid rgba(16, 185, 129, 0.2);
    }

    .dark .feedback-message {
        background-color: rgba(16, 185, 129, 0.2);
        border-color: rgba(16, 185, 129, 0.3);
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    /* Responsive adjustments */
    @media (max-width: 576px) {
        .feedback-section {
            flex-direction: column;
            align-items: flex-start;
            gap: 16px;
            padding: 12px;
        }

        .feedback-section::before {
            margin-right: 0;
            margin-bottom: 4px;
        }

        .btn-feedback {
            width: 100%;
            justify-content: center;
        }
    }

        /* Dark mode variables */
        .dark {
            --primary: #1E40AF;
            --primary-dark: #0A2463;
            --primary-light: #3B82F6;
            --secondary: #FBBF24;
            --secondary-dark: #F59E0B;
            --secondary-light: #FCD34D;
            --accent: #1F2937;
            --text-dark: #F9FAFB;
            --text-light: #D1D5DB;
            --background-light: #1F2937;
            --background-dark: #F9FAFB;
            --border-light: #374151;
        }

        /* Base styles */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: var(--font-primary);
        }

        body {
            background-color: var(--background-light);
            background-image: url('/static/ise.jpg');
            background-size: cover;
            background-repeat: no-repeat;
            background-position: center center;
            background-attachment: fixed;
            color: var(--text-dark);
            line-height: 1.0;
            transition: var(--transition);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: var(--spacing-4);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            position: relative;
        }

        .dark body {
            background-color: var(--background-dark);
        }

        body::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
        }

        .dark body::before {
            background: rgba(31, 41, 55, 0.7);
        }

        body[lang="ar"] {
            direction: rtl;
            text-align: right;
        }

        a {
            text-decoration: none;
            color: var(--primary);
            transition: var(--transition);
        }

        a:hover {
            color: var(--primary-light);
        }

        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        ::-webkit-scrollbar-track {
            background: var(--accent);
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--primary-light);
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary);
        }

        .card {
            background-color: var(--background-light);
            border-radius: var(--border-radius-lg);
            overflow: hidden;
            box-shadow: var(--box-shadow-md);
            transition: var(--transition);
            width: 100%;
            max-width: 40rem;
            padding: var(--spacing-8);
            position: relative;
            opacity: 0;
            transform: translateY(20px);
            animation: fadeInUp 0.6s ease-out forwards;
        }

        .dark .card {
            background: rgba(31, 41, 55, 0.95);
        }

        @keyframes fadeInUp {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: var(--box-shadow-lg);
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-8);
            border-bottom: 1px solid var(--border-light);
            padding-bottom: var(--spacing-4);
        }

        .header h1 {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--text-dark);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .dark .header h1 {
            color: var(--text-light);
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            border-radius: var(--border-radius);
            font-weight: 600;
            transition: var(--transition);
            border: none;
            cursor: pointer;
            font-size: 1rem;
            position: relative;
            overflow: hidden;
            text-align: center;
            box-shadow: var(--box-shadow-sm);
        }

        .btn::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background-color: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.5s, height 0.5s;
        }

        .btn:active::after {
            width: 300px;
            height: 300px;
            opacity: 0;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: var(--text-light);
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, var(--primary-light), var(--primary));
            transform: translateY(-2px);
            box-shadow: var(--box-shadow-md);
        }

        .btn-light {
            background: var(--background-light);
            color: var(--text-dark);
            border: 1px solid var(--border-light);
        }

        .btn-light:hover {
            background: var(--accent);
            transform: translateY(-2px);
            box-shadow: var(--box-shadow-md);
        }

        .btn-feedback {
            padding: var(--spacing-2) var(--spacing-3);
            font-size: 0.875rem;
            background: var(--background-light);
            color: var(--text-dark);
            border: 1px solid var(--border-light);
            border-radius: var(--border-radius-sm);
        }

        .dark .btn-feedback {
            background: var(--background-dark);
            color: var(--text-light);
            border-color: var(--border-light);
        }

        .btn-feedback:hover {
            background: var(--accent);
            transform: translateY(-1px);
        }

        .btn-feedback.rated,
        .btn-feedback:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .feedback-message {
            margin-top: var(--spacing-3);
            font-size: 0.875rem;
            color: var(--success);
        }

        .dark .feedback-message {
            color: var(--success);
        }

        .form-group {
            margin-bottom: var(--spacing-8);
        }

        .form-group label {
            display: block;
            color: var(--text-dark);
            font-weight: 500;
            margin-bottom: var(--spacing-3);
            font-size: 1.125rem;
        }

        .dark .form-group label {
            color: var(--text-light);
        }

        .form-group .input-group {
            display: flex;
            gap: var(--spacing-3);
            align-items: center;
        }

        .form-group input {
            flex: 1;
            border: 1px solid var(--border-light);
            border-radius: var(--border-radius);
            padding: var(--spacing-4);
            background: white;
            color: var(--text-dark);
            font-size: 1rem;
            transition: var(--transition);
        }

        .dark .form-group input {
            background: var(--background-dark);
            color: var(--text-light);
            border-color: var(--border-light);
        }

        .form-group input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 12px rgba(30, 64, 175, 0.2);
            background: #F0F4FF;
            outline: none;
        }

        .dark .form-group input:focus {
            background: var(--background-dark);
        }

        .form-group input::placeholder {
            color: var(--text-muted);
            font-weight: 400;
        }

        .help-section {
            margin-bottom: var(--spacing-8);
        }

        .help-section h2 {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: var(--spacing-3);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .dark .help-section h2 {
            color: var(--text-light);
        }

        .help-section .help-content {
            background: #EFF6FF;
            border: 1px solid #BFDBFE;
            color: var(--primary-dark);
            padding: var(--spacing-5);
            border-radius: var(--border-radius);
            font-size: 0.9375rem;
            box-shadow: var(--box-shadow-sm);
        }

        .dark .help-section .help-content {
            background: #1E3A8A;
            border-color: #3B82F6;
            color: #BFDBFE;
        }

        .help-section ul {
            list-style-type: none;
            padding: 0;
            margin: 0;
        }

        .help-section ul li {
            display: flex;
            align-items: flex-start;
            gap: 0.5rem;
            margin-bottom: var(--spacing-2);
            padding-left: var(--spacing-2);
            position: relative;
        }

        .help-section ul li::before {
            content: '\f058';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            color: var(--primary);
            font-size: 1rem;
            position: absolute;
            left: 0;
            top: 0.25rem;
        }

        .response-section {
            margin-bottom: var(--spacing-8);
        }

        .response-section h2 {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: var(--spacing-3);
        }

        .dark .response-section h2 {
            color: var(--text-light);
        }

        .response-section .response-content {
            background: var(--background-light);
            padding: var(--spacing-5);
            border-radius: var(--border-radius);
            color: var(--text-dark);
            white-space: pre-wrap;
            border: 1px solid var(--border-light);
            box-shadow: var(--box-shadow-sm);
            font-size: 0.9375rem;
        }

        .dark .response-section .response-content {
            background: var(--background-dark);
            color: var(--text-light);
            border-color: var(--border-light);
        }

        .response-section .response-content.text-danger {
            color: var(--danger);
            font-weight: 500;
            background: #FEE2E2;
            border-color: var(--danger);
        }

        .dark .response-section .response-content.text-danger {
            background: #7F1D1D;
            color: #FECACA;
        }

        .sources-section {
            margin-top: var(--spacing-5);
            padding

-bottom: var(--spacing-5);
        }

        .sources-section h2 {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: var(--spacing-3);
        }

        .dark .sources-section h2 {
            color: var(--text-light);
        }

        .sources-section .sources-list {
            display: flex;
            flex-wrap: wrap;
            gap: var(--spacing-3);
        }

        .sources-section a {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: var(--background-light);
            color: var(--text-dark);
            font-size: 0.875rem;
            padding: var(--spacing-2) var(--spacing-4);
            border-radius: var(--border-radius);
            transition: var(--transition);
            border: 1px solid var(--border-light);
            box-shadow: var(--box-shadow-sm);
        }

        .dark .sources-section a {
            background: var(--background-dark);
            color: var(--text-light);
            border-color: var(--border-light);
        }

        .sources-section a:hover {
            background: #E0E7FF;
            color: var(--primary);
            transform: translateY(-2px);
            box-shadow: var(--box-shadow-md);
        }

        .dark .sources-section a:hover {
            background: #374151;
        }

        .sources-section img {
            width: 1.25rem;
            height: 1.25rem;
            border-radius: var(--border-radius-sm);
        }

        footer {
            text-align: center;
            margin-top: var(--spacing-8);
            color: var(--text-muted);
            font-size: 0.875rem;
            padding-top: var(--spacing-4);
            border-top: 1px solid var(--border-light);
        }

        .dark footer {
            color: var(--text-light);
            border-color: var(--border-light);
        }

        .theme-toggle {
            position: fixed;
            top: var(--spacing-5);
            right: var(--spacing-5);
            background: var(--background-light);
            color: var(--text-dark);
            border-radius: var(--border-radius);
            padding: var(--spacing-3);
            box-shadow: var(--box-shadow-sm);
            transition: var(--transition);
            cursor: pointer;
            z-index: 1000;
        }

        .dark .theme-toggle {
            background: var(--background-dark);
            color: var(--text-light);
        }

        .theme-toggle:hover {
            transform: scale(1.1);
            box-shadow: var(--box-shadow-md);
        }

        .language-selector {
            position: fixed;
            top: var(--spacing-5);
            left: var(--spacing-5);
            background: var(--background-light);
            color: var(--text-dark);
            border-radius: var(--border-radius);
            padding: var(--spacing-3);
            box-shadow: var(--box-shadow-sm);
            transition: var(--transition);
            cursor: pointer;
            z-index: 1000;
            font-size: 0.875rem;
        }

        .dark .language-selector {
            background: var(--background-dark);
            color: var(--text-light);
        }

        .language-selector:hover {
            transform: scale(1.1);
            box-shadow: var(--box-shadow-md);
        }

        @media (max-width: 768px) {
            body {
                background-attachment: scroll;
                background-position: center center;
            }

            body::before {
                background: rgba(249, 250, 251, 0.85);
            }

            .dark body::before {
                background: rgba(31, 41, 55, 0.85);
            }

            .card {
                padding: var(--spacing-6);
                max-width: 90%;
            }

            .header {
                flex-direction: column;
                gap: var(--spacing-4);
                align-items: flex-start;
            }

            .form-group .input-group {
                flex-direction: column;
                gap: var(--spacing-4);
            }

            .form-group input,
            .form-group button {
                width: 100%;
            }

            .header h1 {
                font-size: 1.5rem;
            }

            .help-section h2,
            .response-section h2 {
                font-size: 1.25rem;
            }

            .sources-section h2 {
                font-size: 1.125rem;
            }

            .language-selector {
                top: var(--spacing-10);
            }
        }

        @media (max-width: 576px) {
            .card {
                padding: var(--spacing-4);
            }

            .btn {
                padding: 0.6rem 1.2rem;
                font-size: 0.9375rem;
            }

            .btn-feedback {
                padding: var(--spacing-2);
                font-size: 0.75rem;
            }

            .form-group label {
                font-size: 1rem;
            }

            .form-group input {
                padding: var(--spacing-3);
            }
        }
        .btn-copy {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    padding: 8px 16px;
    border-radius: 6px;
    font-size: 14px;
    font-weight: 500;
    transition: all 0.2s ease;
    border: none;
    cursor: pointer;
    background: var(--info);
    color: var(--text-light);
    position: relative;
    overflow: hidden;
}

.dark .btn-copy {
    background: #17a2b8;
}

.btn-copy:hover {
    background: #138496;
}

.btn-copy::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 0;
    height: 0;
    background-color: rgba(255, 255, 255, 0.2);
    border-radius: 50%;
    transform: translate(-50%, -50%);
    transition: width 0.4s, height 0.4s;
    z-index: -1;
}

.btn-copy:hover::after {
    width: 150px;
    height: 150px;
}

.btn-copy i {
    margin-right: 4px;
}

.btn-copy:active {
    transform: scale(0.95);
}

        .text-primary { color: var(--primary) !important; }
        .mb-3 { margin-bottom: 1rem !important; }
        .mt-3 { margin-top: 1rem !important; }
        .d-flex { display: flex !important; }
        .justify-content-between { justify-content: space-between !important; }
        .align-items-center { align-items: center !important; }
        .gap-3 { gap: var(--spacing-3) !important; }
        .gap-10 { gap: var(--spacing-8) !important; }
    </style>
</head>
<body>
    <select id="language-selector" class="language-selector">
        <option value="en" data-i18n="header.lang_en">English</option>
        <option value="fr" data-i18n="header.lang_fr">French</option>
        <option value="ar" data-i18n="header.lang_ar">Arabic</option>
    </select>

    <div class="card">
        <div class="header">
            <h1><i class="fas fa-robot"></i> <span data-i18n="header.title">ISET Sfax AI Assistant</span></h1>
            <div class="d-flex align-items-center gap-10">
                <a href="{{ url_for('main.index_interface') }}" class="btn btn-primary" style="margin-right:10px;">
                    <i class="fas fa-arrow-left"></i> <span data-i18n="header.back">Back</span>
                </a>
                <a href="{{ url_for('main.logout') }}" class="btn btn-light">
                    <i class="fas fa-sign-out-alt"></i> <span data-i18n="header.logout">Logout</span>
                </a>
            </div>
        </div>

        <form method="POST" action="{{ url_for('main.dashboard_interface') }}" class="form-group">
            <label for="question" data-i18n="form.label">Ask your question:</label>
            <div class="input-group">
                <input
                    type="text"
                    id="question"
                    name="question"
                    value="{{ question or '' }}"
                    data-i18n="[placeholder]form.placeholder"
                />
                <button type="submit" class="btn btn-primary" data-i18n="form.submit">Submit</button>
            </div>
        </form>

        {% if question and (question.strip().lower() == '/help' or question.strip().lower() == 'aide') %}
        <div class="help-section">
            <h2><i class="fas fa-question-circle"></i> <span data-i18n="help.title">Help - Available Commands</span></h2>
            <div class="help-content">
                <ul>
                    <li data-i18n="help.command_help"><strong>/help</strong> or <strong>aide</strong>: Displays this help.</li>
                    <li data-i18n="help.command_question">Ask a question freely (e.g., "What are ISET Sfax schedules?").</li>
                    <li data-i18n="help.command_keywords">Use precise keywords for better responses (e.g., "ISET Sfax programs").</li>
                    <li data-i18n="help.command_joke">Request a joke (e.g., "joke").</li>
                    <li data-i18n="help.command_quote">Get a quote (e.g., "quote").</li>
                    <li data-i18n="help.command_sources">Sources will be displayed if a web search is performed.</li>
                    <li data-i18n="help.command_feedback">Provide feedback on responses with 👍 or 👎 to improve the chatbot.</li>
                </ul>
            </div>
        </div>
        {% elif response %}
        <div class="response-section">
            <h2 data-i18n="response.title">Response</h2>
            <div class="response-content {{ 'text-danger' if response.startswith('Désolé') or response.startswith('Une erreur') else '' }}">
                <p>{{ response | safe }}</p>
            </div>
            <div class="d-flex gap-3 mt-3">
        <button class="btn-copy">
            <i class="fas fa-copy"></i> <span data-i18n="response.copy">Copy Response</span>
        </button>
    </div>
            <div class="feedback-section d-flex gap-3 mt-3">
                <button class="btn-feedback" data-rating="positive" data-response-id="{{ response_id or 'temp' }}">
                    <i class="fas fa-thumbs-up"></i> <span data-i18n="feedback.positive">Helpful</span>
                </button>
                <button class="btn-feedback" data-rating="negative" data-response-id="{{ response_id or 'temp' }}">
                    <i class="fas fa-thumbs-down"></i> <span data-i18n="feedback.negative">Not Helpful</span>
                </button>
            </div>
            <div class="feedback-message" style="display: none;"></div>
        </div>
        {% endif %}

        {% if sources and sources|length > 0 %}
        <div class="sources-section">
            <h2 data-i18n="sources.title">Sources</h2>
            <div class="sources-list">
                {% for src in sources %}
                <a href="{{ src.url }}" target="_blank">
                    <img src="https://www.google.com/s2/favicons?domain={{ src.url }}" alt=""/>
                    <span>{{ src.label }}</span>
                </a>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <footer>
            <p data-i18n="footer.copyright">© 2025 ISET Sfax. All rights reserved.</p>
        </footer>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/2.4.0/purify.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/i18next@21.9.2/dist/umd/i18next.min.js"></script>
    <script>
        // Utility function to get cookie value
        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
            return null;
        }

        // UUID generator for temporary response IDs
        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                const r = Math.random() * 16 | 0, v = c === 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        // Initialize i18next
        i18next.init({
            lng: getCookie('language') || 'en',
            resources: {
                en: {
                    translation: {
                        'header.title': 'ISET Sfax AI Assistant',
                        'header.back': 'Back',
                        'header.logout': 'Logout',
                        'header.lang_en': 'English',
                        'header.lang_fr': 'French',
                        'header.lang_ar': 'Arabic',
                        'form.label': 'Ask your question:',
                        'form.placeholder': 'E.g., "ISET Sfax programs" or "contact"',
                        'form.submit': 'Submit',
                        'help.title': 'Help - Available Commands',
                        'help.command_help': '<strong>/help</strong> or <strong>aide</strong>: Displays this help.',
                        'help.command_question': 'Ask a question freely (e.g., "What are ISET Sfax schedules?").',
                        'help.command_keywords': 'Use precise keywords for better responses (e.g., "ISET Sfax programs").',
                        'help.command_joke': 'Request a joke (e.g., "joke").',
                        'help.command_quote': 'Get a quote (e.g., "quote").',
                        'help.command_sources': 'Sources will be displayed if a web search is performed.',
                        'help.command_feedback': 'Provide feedback on responses with 👍 or 👎 to improve the chatbot.',
                        'response.title': 'Response',
                        'response.copy': 'Copy Response',
                        'feedback.positive': 'Helpful',
                        'feedback.negative': 'Not Helpful',
                        'feedback.success': 'Thank you for your feedback!',
                        'feedback.error': 'Error submitting feedback.',
                        'feedback.network_error': 'Network error. Please try again.',
                        'sources.title': 'Sources',
                        'response.copy_success': 'Response copied to clipboard!',
                        'response.copy_error': 'Failed to copy response.',
                        'footer.copyright': '© 2025 ISET Sfax. All rights reserved.'
                    }
                },
                fr: {
                    translation: {
                        'header.title': 'Assistant IA ISET Sfax',
                        'header.back': 'Retour',
                        'header.logout': 'Déconnexion',
                        'header.lang_en': 'Anglais',
                        'header.lang_fr': 'Français',
                        'header.lang_ar': 'Arabe',
                        'form.label': 'Posez votre question :',
                        'form.placeholder': 'Ex. : "programmes ISET Sfax" ou "contact"',
                        'form.submit': 'Envoyer',
                        'help.title': 'Aide - Commandes disponibles',
                        'help.command_help': '<strong>/help</strong> ou <strong>aide</strong> : Affiche cette aide.',
                        'help.command_question': 'Posez une question librement (ex. : "Quels sont les horaires de l’ISET ?").',
                        'help.command_keywords': 'Utilisez des mots-clés précis pour de meilleures réponses (ex. : "programmes ISET Sfax").',
                        'help.command_joke': 'Demander une blague (ex. : "blague").',
                        'help.command_quote': 'Obtenir une citation (ex. : "citation").',
                        'help.command_sources': 'Des sources seront affichées si une recherche web est effectuée.',
                        'help.command_feedback': 'Donnez votre avis sur les réponses avec 👍 ou 👎 pour améliorer le chatbot.',
                        'response.title': 'Réponse',
                        'response.copy': 'Copier la réponse',
                        'feedback.positive': 'Utile',
                        'feedback.negative': 'Non utile',
                        'feedback.success': 'Merci pour votre avis !',
                        'feedback.error': 'Erreur lors de l’envoi de l’avis.',
                        'feedback.network_error': 'Erreur réseau. Veuillez réessayer.',
                        'response.copy_success': 'Réponse copiée dans le presse-papiers !',
                        'response.copy_error': 'Échec de la copie de la réponse.',
                        'sources.title': 'Sources',
                        'footer.copyright': '© 2025 ISET Sfax. Tous droits réservés.'
                    }
                },
                ar: {
                    translation: {
                        'header.title': 'مساعد الذكاء الاصطناعي ISET صفاقس',
                        'header.back': 'رجوع',
                        'header.logout': 'تسجيل الخروج',
                        'header.lang_en': 'الإنجليزية',
                        'header.lang_fr': 'الفرنسية',
                        'header.lang_ar': 'العربية',
                        'form.label': 'اطرح سؤالك:',
                        'form.placeholder': 'مثال: "برامج ISET صفاقس" أو "الاتصال"',
                        'form.submit': 'إرسال',
                        'help.title': 'المساعدة - الأوامر المتاحة',
                        'help.command_help': '<strong>/help</strong> أو <strong>مساعدة</strong>: يعرض هذه المساعدة.',
                        'help.command_question': 'اطرح سؤالًا بحرية (مثال: "ما هي مواعيد ISET صفاقس؟").',
                        'help.command_keywords': 'استخدم كلمات مفتاحية دقيقة للحصول على إجابات أفضل (مثال: "برامج ISET صفاقس").',
                        'help.command_joke': 'اطلب نكتة (مثال: "نكتة").',
                        'help.command_quote': 'احصل على اقتباس (مثال: "اقتباس").',
                        'help.command_sources': 'سيتم عرض المصادر إذا تم إجراء بحث على الويب.',
                        'help.command_feedback': 'قدم ملاحظات على الإجابات باستخدام 👍 أو 👎 لتحسين الشاتبوت.',
                        'response.title': 'الإجابة',
                        'response.copy': 'نسخ الإجابة',
                        'feedback.positive': 'مفيد',
                        'feedback.negative': 'غير مفيد',
                        'feedback.success': 'شكرًا على ملاحظاتك!',
                        'feedback.error': 'خطأ أثناء إرسال الملاحظات.',
                        'feedback.network_error': 'خطأ في الشبكة. حاول مرة أخرى.',
                        'response.copy_success': 'تم نسخ الإجابة إلى الحافظة!',
                        'response.copy_error': 'فشل نسخ الإجابة.',
                        'sources.title': 'المصادر',
                        'footer.copyright': '© 2025 ISET صفاقس. جميع الحقوق محفوظة.'
                    }
                }
            }
        }, (err, t) => {
            if (err) {
                console.error('i18next initialization failed:', err);
                return;
            }

            // Function to update the DOM with translations
            function updateContent() {
                document.querySelectorAll('[data-i18n]').forEach(element => {
                    const key = element.getAttribute('data-i18n');
                    const attributeMatch = key.match(/\[(.+)\](.+)/);
                    if (attributeMatch) {
                        const attribute = attributeMatch[1];
                        const translationKey = attributeMatch[2];
                        element.setAttribute(attribute, t(translationKey));
                    } else {
                        element.innerHTML = t(key);
                    }
                });

                // Update title separately
                document.title = t('header.title');
            }

            // Initial content update
            updateContent();

            // Language selector
            const languageSelector = document.getElementById('language-selector');
            languageSelector.value = i18next.language;
            languageSelector.addEventListener('change', (e) => {
                const newLang = e.target.value;
                i18next.changeLanguage(newLang, () => {
                    updateContent();
                    document.cookie = `language=${newLang}; path=/; max-age=31536000`;
                    document.documentElement.setAttribute('lang', newLang);
                    document.body.setAttribute('lang', newLang);
                });
            });

            // Theme toggle
            const themeToggle = document.createElement('button');
            themeToggle.className = 'theme-toggle';
            themeToggle.innerHTML = '<i id="theme-icon" class="fas fa-moon"></i>';
            document.body.appendChild(themeToggle);

            themeToggle.addEventListener('click', () => {
                document.body.classList.toggle('dark');
                const isDark = document.body.classList.contains('dark');
                document.getElementById('theme-icon').className = isDark ? 'fas fa-sun' : 'fas fa-moon';
                localStorage.setItem('theme', isDark ? 'dark' : 'light');
            });

            // Auto-detect system theme and apply saved theme
            document.addEventListener('DOMContentLoaded', () => {
                const savedTheme = localStorage.getItem('theme');
                const prefersDarkScheme = window.matchMedia('(prefers-color-scheme: dark)').matches;

                if (savedTheme === 'dark' || (!savedTheme && prefersDarkScheme)) {
                    document.body.classList.add('dark');
                    document.getElementById('theme-icon').className = 'fas fa-sun';
                }

                // Feedback button event listeners
                const feedbackButtons = document.querySelectorAll('.btn-feedback');
                feedbackButtons.forEach(button => {
                    button.addEventListener('click', async () => {
                        let responseId = button.getAttribute('data-response-id');
                        const rating = button.getAttribute('data-rating');
                        const feedbackSection = button.closest('.feedback-section');
                        const feedbackMessage = feedbackSection.nextElementSibling;

                        // Generate UUID if responseId: Generate UUID if responseId is 'temp'
                        if (responseId === 'temp') {
                            responseId = generateUUID();
                            button.setAttribute('data-response-id', responseId);
                            feedbackSection.querySelectorAll('.btn-feedback').forEach(btn => {
                                btn.setAttribute('data-response-id', responseId);
                            });
                        }

                        try {
                            const response = await fetch('/submit_feedback', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify({ response_id: responseId, rating }),
                            });

                            const result = await response.json();
                            if (result.success) {
                                feedbackMessage.textContent = t('feedback.success');
                                feedbackMessage.style.display = 'block';
                                feedbackButtons.forEach(btn => {
                                    btn.disabled = true;
                                    btn.classList.add('rated');
                                });
                            } else {
                                feedbackMessage.textContent = t('feedback.error');
                                feedbackMessage.style.color = 'var(--danger)';
                                feedbackMessage.style.display = 'block';
                            }
                        } catch (error) {
                            feedbackMessage.textContent = t('feedback.network_error');
                            feedbackMessage.style.color = 'var(--danger)';
                            feedbackMessage.style.display = 'block';
                        }
                    });
                });
                // Copy button event listener
                const copyButtons = document.querySelectorAll('.btn-copy');
                copyButtons.forEach(button => {
                    button.addEventListener('click', async () => {
                        const responseSection = button.closest('.response-section');
                        const responseContent = responseSection.querySelector('.response-content').textContent.trim();
                        const feedbackMessage = responseSection.querySelector('.feedback-message');

                        try {
                            await navigator.clipboard.writeText(responseContent);
                            feedbackMessage.textContent = t('response.copy_success');
                            feedbackMessage.style.color = 'var(--success)';
                            feedbackMessage.style.display = 'block';
                            setTimeout(() => {
                                feedbackMessage.style.display = 'none';
                            }, 2000);
                        } catch (error) {
                            feedbackMessage.textContent = t('response.copy_error');
                            feedbackMessage.style.color = 'var(--danger)';
                            feedbackMessage.style.display = 'block';
                        }
                    });
                });
            });
        });
    </script>
</body>
</html>